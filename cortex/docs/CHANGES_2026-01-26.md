# Changes 2026-01-26

> **⚠️ HISTORICAL DOCUMENT** - This is a historical change log from 2026-01-26. For current work status, see [workers/workers/IMPLEMENTATION_PLAN.md](../../workers/IMPLEMENTATION_PLAN.md) and [workers/ralph/workers/ralph/THUNK.md](../../workers/ralph/THUNK.md).

## Critical Infrastructure Changes

### Token Efficiency Rules (HIGH IMPACT)

Added mandatory startup procedure and token efficiency rules to `workers/ralph/PROMPT.md`:

**Startup Procedure (Cheap First):**

- Must start with cheap discovery (grep/ls/find), not open_files
- Forbidden files at startup: NEURONS.md, THOUGHTS.md, full IMPL_PLAN, workers/ralph/THUNK.md
- Use sliced reads (head/tail/sed) instead of full file opens

**New Token Efficiency Rules:**

1. **Validator Errors: Smallest Reproduction First** - Re-run failing hook on single file, inspect validator logic before editing docs
2. **Commit Atomicity** - IMPL_PLAN + THUNK updates must be staged together
3. **Search Explosion Guard** - If output >100 lines, stop and narrow scope
4. **THUNK Lookup Path** - Use thunk-parse/brain-search, not cat/grep on workers/ralph/THUNK.md

### Tripwire Script (HIGH IMPACT)

Created `tools/check_startup_rules.sh` to verify Ralph follows token efficiency rules:

- Detects open_files calls to forbidden large files
- Detects full file opens without slicing
- Detects broad grep patterns that return too many results
- FAIL on broad searches in first 5 calls

---

## Loop Efficiency & Correctness (Phase 23)

### Scoped Git Staging (HIGH IMPACT)

Replaced `git add -A` with scoped staging to prevent unrelated files from being committed:

- `stage_scoped_changes()` function only stages files related to current task
- Stages: workers/IMPLEMENTATION_PLAN.md, workers/ralph/THUNK.md, modified files from task
- Protected hash files (`.verify/*.sha256`) staged when needed
- Prevents "everything committed" anti-pattern

### Plan Cleanup Improvements

- Fixed path resolution in `cleanup_plan.sh` using `git rev-parse --show-toplevel`
- Added deduplication to prevent duplicate archived tasks in workers/PLAN_DONE.md
- Validation for malformed task entries

### Performance Optimizations

- Skip pre-build verifier when no changes exist
- Incremental pre-commit (staged files only)
- Skip fix-markdown/pre-commit when no relevant files changed

### End-of-Run Flush Commit Guarantee (HIGH IMPACT)

Ensures runs ending on BUILD do not leave uncommitted work:

- Added `flush_scoped_commit_if_needed()` and call sites in `workers/ralph/loop.sh`
  - Flushes on graceful interrupt
  - Flushes at end-of-run
  - Skips in `--dry-run`
  - Uses scoped staging (`stage_scoped_changes`) to avoid committing noise
- Propagated the same behavior to `templates/ralph/loop.sh`
- Updated protected hash baselines (`.verify/**/loop.sha256`)

---

## PLAN-ONLY Mode Guardrails (Phase 24)

### Guard Function

Added `guard_plan_only_mode()` to `workers/shared/common.sh`:

- Returns 0=allowed, 1=blocked
- Disabled when `RALPH_MODE != PLAN`
- Blocks: git-write, file-modify, verification commands
- Allows: read operations, workers/IMPLEMENTATION_PLAN.md edits

### Documentation

Added PLAN-ONLY Mode Boundaries section to `cortex/AGENTS.md`:

- Environment variable: `RALPH_MODE=PLAN`
- Blocked categories with examples
- Fail-safe design (violations return non-zero)

### Test Suite

Created `tools/test_plan_only_guard.sh` with 15 test cases:

- PLAN mode blocks 7 forbidden actions
- PLAN mode allows 5 read operations
- BUILD mode allows all operations

---

## Error Handling Improvements (Phase 24)

### Session 404 Error Filter

Created `workers/shared/filter_acli_errors.sh`:

- Detects "Session termination failed: 404" pattern
- Classified as HARMLESS-NOISE (external acli cleanup)
- Suppresses in normal mode, shows in DEBUG mode
- Dedupe/throttle for repeated errors

---

## Anti-Patterns Documentation (Phase 16)

Created comprehensive anti-patterns documentation:

- `skills/domains/anti-patterns/README.md` - Format guidelines
- `skills/domains/anti-patterns/shell-anti-patterns.md` - 8 shell patterns (SC2155, SC2034, etc.)
- `skills/domains/anti-patterns/markdown-anti-patterns.md` - Common markdown mistakes
- `skills/domains/anti-patterns/ralph-anti-patterns.md` - Ralph loop anti-patterns
- `skills/domains/anti-patterns/documentation-anti-patterns.md` - Doc writing mistakes

---

## Tools Documentation

Updated `docs/TOOLS.md` with newly documented tools:

- `tools/thunk_dedup.sh` - THUNK deduplication
- `tools/skill_freshness.sh` - Skill age checker
- `tools/brain_dashboard/` - Metrics dashboard
- `tools/skill_graph/` - Skill dependency graph
- `tools/pattern_miner/` - Commit pattern discovery
- `tools/skill_quiz/` - Interactive knowledge quiz
- `tools/test_plan_only_guard.sh` - PLAN-ONLY mode tests

---

## Markdown Lint Fixes (Phase 22)

Batch fixes for markdown lint errors across repository:

- MD056 (table column counts) in workers/ralph/THUNK.md
- MD055 (table pipe style) in workers/ralph/THUNK.md
- MD024 (duplicate headings) in workers/PLAN_DONE.md
- MD032 (blanks around lists) in various files

---

## Key Commits

| Commit | Description |
|--------|-------------|
| 21d61a9 | docs(plan): add Phase 22.10 and 22.11 markdown lint tasks |
| 8473294 | docs(decisions): add DEC-2026-01-26-001 shfmt source of truth |
| 7304a80 | fix(loop): handle stage_scoped_changes return 1 with set -e |
| 4d3cfa8 | docs(cortex): enforce markdown fix+lint before commit |
| fd9c1ff | fix(loop): plan cleanup path; stage protected hashes; align drift message |
| 0f6a3e8 | feat(loop): replace git add -A with scoped staging |
| 43ecfc3 | docs(prompt): add THUNK pre-check instruction in BUILD mode |
| fa3c50b | fix(fix-markdown): accept multiple file arguments |
| 0e1aaa6 | feat(snapshot): add --no-dashboard flag |
| cb2c4a6 | feat(ralph): batch commits at PLAN start; BUILD stages only |
| 2818a0b | fix(loop): flush pending changes at end-of-run (even if last iteration is BUILD) |

---

## Summary

**Today's focus:** Loop efficiency, correctness, and guardrails.

Key achievements:

1. ✅ Scoped git staging (prevents unrelated file commits)
2. ✅ PLAN-ONLY mode guardrails (prevents accidental implementation)
3. ✅ Session 404 error filtering (cleaner output)
4. ✅ Anti-patterns documentation (learning from failures)
5. ✅ Tools documentation updated (all tools now documented)
6. ✅ Markdown lint fixes (clean verifier output)
