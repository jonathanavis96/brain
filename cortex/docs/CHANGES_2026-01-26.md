# Changes 2026-01-26

## Critical Infrastructure Changes

### Token Efficiency Rules (HIGH IMPACT)

Added mandatory startup procedure and token efficiency rules to `workers/ralph/PROMPT.md`:

**Startup Procedure (Cheap First):**

- Must start with cheap discovery (grep/ls/find), not open_files
- Forbidden files at startup: NEURONS.md, THOUGHTS.md, full IMPL_PLAN, THUNK.md
- Use sliced reads (head/tail/sed) instead of full file opens

**New Token Efficiency Rules:**

1. **Validator Errors: Smallest Reproduction First** - Re-run failing hook on single file, inspect validator logic before editing docs
2. **Commit Atomicity** - IMPL_PLAN + THUNK updates must be staged together
3. **Search Explosion Guard** - If output >100 lines, stop and narrow scope
4. **THUNK Lookup Path** - Use thunk-parse/brain-search, not cat/grep on THUNK.md

### Tripwire Script (HIGH IMPACT)

Created `tools/check_startup_rules.sh` to verify Ralph follows token efficiency rules:

**Checks:**

- Check 1: No forbidden startup file opens (NEURONS.md, THOUGHTS.md)
- Check 2a: THUNK.md not opened via open_files
- Check 2b: THUNK.md not read via cat/grep/awk/sed (tail for append OK)
- Check 3: IMPLEMENTATION_PLAN.md not opened in full (WARN only)
- Check 4: Grep explosion detection (FAIL on indicators, WARN on broad globs)
- Check 5: First tool calls are cheap

**Usage:**

```bash
tools/check_startup_rules.sh                    # Check latest log
tools/check_startup_rules.sh path/to/log.log   # Check specific log
```

### Rule 6: Task Destination (MEDIUM IMPACT)

Added Rule 6 to `cortex/AGENTS.md`:

- `workers/IMPLEMENTATION_PLAN.md` is the source of truth (Ralph reads here)
- `cortex/IMPLEMENTATION_PLAN.md` is a read-only copy
- Sync direction: workers/ â†’ cortex/ (via sync_cortex_plan.sh)

## Documentation Updates

- Added `check_startup_rules.sh` to `docs/TOOLS.md` (Validation Tools section)
- Added Phase 21 tasks to `workers/IMPLEMENTATION_PLAN.md`

## Commits

| Commit | Description |
|--------|-------------|
| d67b549 | feat(tools): add check_startup_rules.sh tripwire for token efficiency |
| 9b087a7 | feat(prompt): add token efficiency rules and cheap startup procedure |
| fa28405 | fix(agents): add rule that tasks go to workers/IMPLEMENTATION_PLAN.md |
| 9075ed5 | chore(tools): strengthen startup rule tripwire |

## Why These Changes Matter

These changes address a **core cost problem**: Ralph was opening large files unnecessarily at startup, wasting tokens on context that wasn't needed. The combination of:

1. **Rules in PROMPT.md** - Tell Ralph what NOT to do
2. **Tripwire script** - Verify Ralph actually follows the rules

Creates a **feedback loop** where we can detect violations and tighten rules as needed. This is more reliable than hoping the LLM "behaves today."

## Validation

Both Ralph iterations after these changes passed the tripwire:

- All critical checks: PASS
- Verifier: 58 PASS, 0 FAIL
