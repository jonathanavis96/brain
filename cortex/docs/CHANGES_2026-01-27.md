# Changes — 2026-01-27

> **⚠️ HISTORICAL DOCUMENT** - This is a historical change log from 2026-01-27. For current work status, see [workers/workers/IMPLEMENTATION_PLAN.md](../../workers/IMPLEMENTATION_PLAN.md) and [workers/ralph/workers/ralph/THUNK.md](../../workers/ralph/THUNK.md).

Date: 2026-01-27 00:58:31

## Summary

This entry captures work completed late 2026-01-26 / early 2026-01-27.

- Added a new planning phase to align templates with the canonical Ralph layout `workers/ralph/` (ADR-0001).
- Quarantined and then safely restored local WIP changes via stashes + WIP branches.
- Updated protected hash baselines after approving a change to `workers/ralph/loop.sh`.

## Details

### Planning: Template Drift Alignment (A1)

- Updated `workers/workers/IMPLEMENTATION_PLAN.md` with **Phase 24: Template Drift Alignment (A1)**.
  - Derived from `TEMPLATE_DRIFT_REPORT.md` and `cortex/docs/ADR-0001-canonical-ralph-layout-workers-ralph.md`.
  - Included PR-sized, dependency-ordered task contracts.
  - Included a "Decisions Needed" section with concrete inspection paths + suggested defaults.
  - Followed plan workflow: tasks inserted above marker; marker moved to end.

### Git hygiene: quarantine + restore

- Pushed the clean plan commit to `origin/brain-work`.
- Quarantined existing dirty working tree into an umbrella stash, then split into smaller stashes:
  - artifacts
  - cortex plan/reports
  - templates/workers scripts
- Exported patch files for stashes (`tmp_rovodev_stash_*.patch`).
- Converted the split stashes into WIP branches with commits, pushed to origin.
- Restored WIP changes back into `brain-work` safely.

### Protected file change: `workers/ralph/loop.sh`

- Approved and kept a small observability/header change in `workers/ralph/loop.sh`:
  - Added `# RUNNER: $RUNNER`
  - Added a "single source of truth" model line printed as `# MODEL: ...` using `RESOLVED_MODEL` with fallback to `MODEL_ARG` (default `auto`).
- Updated the protected hash baseline to match:
  - `workers/ralph/.verify/loop.sha256`
- Committed as an isolated protected-hash update (to avoid mixing unrelated changes).

### Templates/workers script WIP restoration

- Committed restoration of related WIP script/template changes as a separate commit:
  - `templates/ralph/PROMPT.md`
  - `templates/ralph/loop.sh`
  - `templates/ralph/cleanup_plan.sh` (new)
  - `workers/ralph/cleanup_plan.sh`

## Commits

- `f60b285` — plan(workers): add Phase 24 template drift alignment (A1)
- `00f80b1` — wip(artifacts): update dashboard and brain metrics
- `4fef277` — wip(cortex): quarantine plan cleanup + drift report + ADR
- `ede3824` — merge: restore WIP artifacts updates
- `1525029` — merge: restore WIP cortex plan+reports
- `a386a2c` — chore(verify): update protected hash for workers/ralph/loop.sh
- `4411217` — wip(ralph): restore templates loop/prompt + cleanup plan

## References

- `TEMPLATE_DRIFT_REPORT.md`
- `cortex/docs/ADR-0001-canonical-ralph-layout-workers-ralph.md`

## Notes

- The umbrella stash used for quarantine was confirmed redundant after restoration and then dropped.
- Split stashes were intentionally retained temporarily for safety.

---

## Brain Map: canonical spec + implementation planning

Date: 2026-01-27

### Why

- Rapid growth of ideas/systems/tasks in the Brain repo requires a **GUI-first, searchable, visual knowledge graph** that can also produce **deterministic agent-ingestible plans**.
- Primary goals include neuron-like layout, search, hotspots/heat overlays, zoom levels, and plan generation aligned to the existing Cortex (planner) / Ralph (builder) workflow.

### Decisions and hard requirements captured

- **Local-first, repo-friendly design:**
  - Source of truth is **Markdown notes**.
  - A **SQLite index** is derived for fast search + graph queries.
- **Stack (assumed and fixed in spec):**
  - UI: Vite + React
  - Graph rendering: sigma.js + graphology
  - Backend: FastAPI
  - Runtime: WSL2; UI accessed from Windows browser via `localhost`
- **Identity model (critical):**
  - Node `id` is immutable once created; titles and filenames may change.
  - Relationships resolve by `id` only.
  - Duplicate ids are a hard index-time error.
- **Inbox capture mode:**
  - Low-friction scratchpad node type with minimal required fields.
  - Promotion flow Inbox → Concept/System/Decision/TaskContract/Artifact without changing id.
- **Failure & recovery:**
  - Index rebuild is atomic (build temp then publish on success).
  - Last known-good index remains usable on failure.
  - System guarantees Markdown is never corrupted (atomic writes; preserve unknown keys).
- **Agent ingestion contract:**
  - Generated plans are authoritative.
  - Ralph must not infer missing requirements or expand scope beyond explicit AC.

### Documents created/updated

- **Canonical spec (authoritative design reference):**
  - `docs/brain-map/brain-map-spec.md`
  - Includes product spec, UX plan, heat metrics, storage model, plan-generation pipeline, identity rules, inbox mode, non-goals, failure model, agent ingestion contract.
- **Appendix added (canonical schema):**
  - “Frontmatter & Link Schema (Canonical)”
  - Canonical examples for each node type and deterministic validation rules.
- **Repo layout + integration section:**
  - Canonical folder structure under `app/brain-map/`
  - Policy for generated outputs and explicit `.gitignore` recommendations.
  - Deterministic repo-root discovery (walk up to find `.git/`, optional env override).
- **REST API contracts section:**
  - MVP-first endpoint definitions, filtering, pagination, deterministic ordering, canonical error shape.
- **Implementation plan:**
  - `docs/brain-map/brain-map-implementation-plan.md`
  - MVP cutline + phased (MVP/V1/V2) atomic Ralph task breakdown (no code).

### Commits (Brain Map)

- `0ed0b7b` — docs(brain-map): add canonical brain map specification
- `1400e83` — docs(brain-map): specify canonical frontmatter and link schema
- `917b2e4` — docs(brain-map): define canonical repo layout and integration
- `f52bd09` — docs(brain-map): add REST API graph query contracts
- `adff55d` — docs(brain-map): add implementation plan

### Tools and commands used

- Repository editing:
  - File creation/updates via standard git workflow.
- Linting:
  - `markdownlint docs/brain-map/brain-map-spec.md`
  - `markdownlint docs/brain-map/brain-map-implementation-plan.md`
- Git operations:
  - `git add <file>`
  - `git commit -m "..."`
  - `git log --oneline -n <N>`
  - `git status --porcelain`

### Notes

- Brain Map work was committed as docs-only changes, and kept logically isolated from unrelated working tree changes.
