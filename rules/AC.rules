# Ralph Acceptance Criteria Rules
# Format: INI-style stanzas
# Keys: mode, gate, desc, cmd, expect_stdout, expect_stdout_regex, expect_exit, instructions
#
# NOTE: Commands run from the ralph/ directory (where verifier.sh lives)

# =============================================================================
# Bug A: Task Extraction (VERIFIED FIXED)
# =============================================================================

[BugA.1]
mode=auto
gate=block
desc=Parser uses in_task_section state tracking
cmd=grep -c 'in_task_section=false' current_ralph_tasks.sh
expect_stdout_regex=^[1-9][0-9]*$
expect_exit=0

[BugA.2]
mode=auto
gate=block
desc=Parser checks for ## (major section) not ### subsections
cmd=grep -E '^\s*elif.*\^\#\#\[' current_ralph_tasks.sh | grep -v '###' | wc -l | tr -d ' '
expect_stdout_regex=^[1-9][0-9]*$
expect_exit=0

# =============================================================================
# Bug B: Display Rendering (VERIFIED FIXED)
# =============================================================================

[BugB.1]
mode=auto
gate=block
desc=Display function uses clear for full redraw
cmd=grep -c 'clear' current_ralph_tasks.sh
expect_stdout_regex=^[1-9][0-9]*$
expect_exit=0

[BugB.2]
mode=auto
gate=block
desc=No differential update logic (LAST_RENDERED)
cmd=grep -c 'LAST_RENDERED' current_ralph_tasks.sh
expect_stdout=0

[BugB.UI.1]
mode=manual
gate=warn
desc=No visual corruption after terminal resize
instructions=Run current_ralph_tasks.sh, resize terminal, confirm display remains intact

# =============================================================================
# Bug C: THUNK Monitor Auto-Sync (NOT FIXED - these should FAIL until fixed)
# =============================================================================

[BugC.1]
mode=auto
gate=block
desc=No scan_for_new_completions function
cmd=grep -c 'scan_for_new_completions' thunk_ralph_tasks.sh
expect_stdout=0

[BugC.2]
mode=auto
gate=block
desc=No PLAN_FILE variable
cmd=grep -c '^PLAN_FILE=' thunk_ralph_tasks.sh
expect_stdout=0

[BugC.3]
mode=auto
gate=block
desc=No "Scanning IMPLEMENTATION_PLAN" message
cmd=grep -c 'Scanning IMPLEMENTATION_PLAN' thunk_ralph_tasks.sh
expect_stdout=0

[BugC.4]
mode=auto
gate=block
desc=Monitor references THUNK.md
cmd=grep -c 'THUNK\.md' thunk_ralph_tasks.sh
expect_stdout_regex=^[1-9][0-9]*$
expect_exit=0

[BugC.5]
mode=auto
gate=block
desc=Monitor does not append/redirect into THUNK.md
cmd=grep -nE '>>\s*.*THUNK\.md|>\s*.*THUNK\.md' thunk_ralph_tasks.sh | wc -l | tr -d ' '
expect_stdout=0

[BugC.6]
mode=auto
gate=block
desc=No task_exists_in_thunk function
cmd=grep -c 'task_exists_in_thunk' thunk_ralph_tasks.sh
expect_stdout=0

[BugC.7]
mode=auto
gate=block
desc=No extract_task_id function
cmd=grep -c 'extract_task_id' thunk_ralph_tasks.sh
expect_stdout=0

[BugC.UI.1]
mode=manual
gate=warn
desc=THUNK monitor only displays, never modifies files
instructions=Run thunk_ralph_tasks.sh, mark a task [x] in IMPLEMENTATION_PLAN.md, confirm THUNK.md is NOT auto-updated

# =============================================================================
# Template Sync Checks
# =============================================================================

[Template.1]
mode=auto
gate=warn
desc=thunk_ralph_tasks.sh matches template
cmd=diff -q thunk_ralph_tasks.sh templates/ralph/thunk_ralph_tasks.sh 2>/dev/null && echo "match" || echo "differ"
expect_stdout=match
expect_exit=0

# =============================================================================
# AntiCheat: Fake Verification Markers (gate=block)
# Prevents Ralph from self-certifying via embedded "proof" comments
# NOTE: Excludes .git, .verify, logs/ (logs are historical evidence)
# =============================================================================

[AntiCheat.1]
mode=auto
gate=block
desc=No fake verification markers in source files
cmd=grep -RIn --include='*.sh' --include='*.md' --exclude-dir=.git --exclude-dir=.verify --exclude-dir=logs --exclude-dir=old_md --exclude='AC.rules' --exclude='IMPLEMENTATION_PLAN.md' "<!-- verified" . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

[AntiCheat.2]
mode=auto
gate=block
desc=No dismissal phrases in active source files
cmd=grep -RIn --include='*.sh' --include='*.md' --exclude-dir=.git --exclude-dir=.verify --exclude-dir=logs --exclude-dir=old_md --exclude='AC.rules' --exclude='PROMPT.md' --exclude='IMPLEMENTATION_PLAN.md' "by design" . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

[AntiCheat.3]
mode=auto
gate=block
desc=No bug reframing in source files
cmd=grep -RIn --include='*.sh' --include='*.md' --exclude-dir=.git --exclude-dir=.verify --exclude-dir=logs --exclude-dir=old_md --exclude='AC.rules' --exclude='IMPLEMENTATION_PLAN.md' "feature, not a bug" . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

[AntiCheat.4]
mode=auto
gate=block
desc=No intended behavior dismissals in source files
cmd=grep -RIn --include='*.sh' --include='*.md' --exclude-dir=.git --exclude-dir=.verify --exclude-dir=logs --exclude-dir=old_md --exclude='AC.rules' --exclude='IMPLEMENTATION_PLAN.md' "works as intended" . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

[AntiCheat.5]
mode=auto
gate=block
desc=No self-certification in source files
cmd=grep -RIn --include='*.sh' --include='*.md' --exclude-dir=.git --exclude-dir=.verify --exclude-dir=logs --exclude-dir=old_md --exclude='AC.rules' --exclude='IMPLEMENTATION_PLAN.md' "verified: this is" . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

# =============================================================================
# Protected File Integrity (gate=block)
# Prevents "edit the judge" attacks
# =============================================================================

[Protected.1]
mode=auto
gate=block
desc=loop.sh unchanged from baseline
cmd=sha256sum loop.sh | cut -d' ' -f1 | diff -q - ../.verify/loop.sha256 >/dev/null 2>&1 && echo "match" || echo "mismatch"
expect_stdout=match

[Protected.2]
mode=auto
gate=block
desc=verifier.sh unchanged from baseline
cmd=sha256sum verifier.sh | cut -d' ' -f1 | diff -q - ../.verify/verifier.sha256 >/dev/null 2>&1 && echo "match" || echo "mismatch"
expect_stdout=match

[Protected.3]
mode=auto
gate=block
desc=PROMPT.md unchanged from baseline
cmd=sha256sum PROMPT.md | cut -d' ' -f1 | diff -q - ../.verify/prompt.sha256 >/dev/null 2>&1 && echo "match" || echo "mismatch"
expect_stdout=match

# =============================================================================
# Verifier Meta-Integrity
# =============================================================================

[VerifyMeta.1]
mode=auto
gate=block
desc=Verifier run_id.txt exists and is non-empty
cmd=test -s ../.verify/run_id.txt && echo "OK" || echo "FAIL"
expect_stdout=OK

# =============================================================================
# Partial Automated Checks (supplements manual review)
# =============================================================================

[BugB.Auto.1]
mode=auto
gate=warn
desc=Display uses terminal-safe cursor positioning (tput)
cmd=grep -c 'tput\|printf.*\\033' current_ralph_tasks.sh
expect_stdout_regex=^[1-9][0-9]*$
expect_exit=0

[BugB.Auto.2]
mode=auto
gate=warn
desc=Display has stty handling for terminal state
cmd=grep -c 'stty' current_ralph_tasks.sh
expect_stdout_regex=^[1-9][0-9]*$
expect_exit=0

[BugC.Auto.1]
mode=auto
gate=block
desc=THUNK monitor has no auto-sync from IMPLEMENTATION_PLAN
cmd=grep -c 'IMPLEMENTATION_PLAN\|PLAN_FILE' thunk_ralph_tasks.sh
expect_stdout=0

[BugC.Auto.2]
mode=auto
gate=warn
desc=THUNK writes limited to era creation only
cmd=grep -nE '>>\s*.*THUNK|>\s*.*THUNK' thunk_ralph_tasks.sh | grep -v 'new.*era\|Era:' | wc -l | tr -d ' '
expect_stdout=0

# === WAIVER META-GATES (added 2026-01-19) ===
# =============================================================================
# Code Hygiene Gates (ADD TO AC.rules)
# Prevents Ralph's recurring mistakes
# =============================================================================

# -----------------------------------------------------------------------------
# Shellcheck / Dead Code Detection
# -----------------------------------------------------------------------------

[Hygiene.Shellcheck.1]
mode=auto
gate=warn
desc=No unused variables in current_ralph_tasks.sh (SC2034)
cmd=shellcheck -f gcc current_ralph_tasks.sh 2>/dev/null | grep -c 'SC2034' || true
expect_stdout=0
expect_exit=0

[Hygiene.Shellcheck.2]
mode=auto
gate=warn
desc=No SC2155 issues in current_ralph_tasks.sh (local var masking)
cmd=shellcheck -f gcc current_ralph_tasks.sh 2>/dev/null | grep -c 'SC2155' || true
expect_stdout=0
expect_exit=0

[Hygiene.Shellcheck.3]
mode=auto
gate=warn
desc=No unused variables in thunk_ralph_tasks.sh (SC2034)
cmd=shellcheck -f gcc thunk_ralph_tasks.sh 2>/dev/null | grep -c 'SC2034' || true
expect_stdout=0
expect_exit=0

[Hygiene.Shellcheck.4]
mode=auto
gate=warn
desc=No SC2155 issues in thunk_ralph_tasks.sh (local var masking)
cmd=shellcheck -f gcc thunk_ralph_tasks.sh 2>/dev/null | grep -c 'SC2155' || true
expect_stdout=0
expect_exit=0

# -----------------------------------------------------------------------------
# Terminology Consistency (kb â†’ skills migration)
# -----------------------------------------------------------------------------

[Hygiene.TermSync.1]
mode=auto
gate=warn
desc=No stale 'kb/' references in active markdown (migration complete)
cmd=rg -l '\bkb/' --include='*.md' --glob='!HISTORY.md' --glob='!CHANGES.md' --glob='!old_md/*' . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

[Hygiene.TermSync.2]
mode=auto
gate=warn
desc=No "Brain KB" terminology (should be "Brain Skills")
cmd=rg -c 'Brain KB' --include='*.md' --glob='!HISTORY.md' --glob='!CHANGES.md' . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

[Hygiene.TermSync.3]
mode=auto
gate=warn
desc=No "KB file" terminology (should be "skill file")
cmd=rg -c 'KB file' --include='*.md' --glob='!HISTORY.md' --glob='!CHANGES.md' . 2>/dev/null | wc -l | tr -d ' '
expect_stdout=0

# -----------------------------------------------------------------------------
# Template Sync Checks
# -----------------------------------------------------------------------------

[Hygiene.TemplateSync.1]
mode=auto
gate=warn
desc=current_ralph_tasks.sh matches template
cmd=diff -q current_ralph_tasks.sh templates/ralph/current_ralph_tasks.sh 2>/dev/null && echo "match" || echo "differ"
expect_stdout=match

[Hygiene.TemplateSync.2]
mode=auto
gate=warn
desc=loop.sh core logic matches template (excluding hashes)
cmd=diff <(grep -v 'sha256\|MODEL_' loop.sh) <(grep -v 'sha256\|MODEL_' templates/ralph/loop.sh) 2>/dev/null && echo "match" || echo "differ"
expect_stdout=match

# -----------------------------------------------------------------------------
# Markdown Validation
# -----------------------------------------------------------------------------

[Hygiene.Markdown.1]
mode=auto
gate=warn
desc=No duplicate H2 headings in IMPLEMENTATION_PLAN.md
cmd=grep -E '^## ' IMPLEMENTATION_PLAN.md | sort | uniq -d | wc -l | tr -d ' '
expect_stdout=0

[Hygiene.Markdown.2]
mode=auto
gate=warn
desc=No code fences without language tags in AGENTS.md
cmd=grep -cE '^```$' AGENTS.md 2>/dev/null || true
expect_stdout=0
expect_exit=0

[Hygiene.Markdown.3]
mode=auto
gate=warn
desc=No code fences without language tags in THOUGHTS.md
cmd=grep -cE '^```$' THOUGHTS.md 2>/dev/null || true
expect_stdout=0
expect_exit=0

[Hygiene.Markdown.4]
mode=auto
gate=warn
desc=No code fences without language tags in NEURONS.md
cmd=grep -cE '^```$' NEURONS.md 2>/dev/null || true
expect_stdout=0
expect_exit=0

# -----------------------------------------------------------------------------
# Documentation Sync (THUNK Monitor specific - Bug C)
# -----------------------------------------------------------------------------

[Hygiene.DocSync.1]
mode=auto
gate=warn
desc=AGENTS.md THUNK monitor docs don't reference removed 'f' hotkey
cmd=grep -A5 'THUNK Monitor' AGENTS.md | grep -c 'force sync\|f.*sync' 2>/dev/null || true
expect_stdout=0
expect_exit=0

[Hygiene.DocSync.2]
mode=auto
gate=warn
desc=AGENTS.md THUNK monitor docs don't claim auto-sync
cmd=grep -A10 'THUNK Monitor' AGENTS.md | grep -c 'Auto-sync\|auto-sync' 2>/dev/null || true
expect_stdout=0
expect_exit=0

# -----------------------------------------------------------------------------
# Status Consistency
# -----------------------------------------------------------------------------

[Hygiene.StatusSync.1]
mode=auto
gate=warn
desc=IMPLEMENTATION_PLAN.md has no conflicting branch status claims
cmd=bash -c 'up=$(grep -c "up to date" IMPLEMENTATION_PLAN.md 2>/dev/null || echo 0); ahead=$(grep -c "commits ahead" IMPLEMENTATION_PLAN.md 2>/dev/null || echo 0); if [[ $up -gt 0 && $ahead -gt 0 ]]; then echo "conflict"; else echo "ok"; fi'
expect_stdout=ok

# -----------------------------------------------------------------------------
# NEURONS.md Structure Accuracy
# -----------------------------------------------------------------------------

[Hygiene.Structure.1]
mode=auto
gate=warn
desc=NEURONS.md skills/ file count is accurate (currently 23+ files)
cmd=bash -c 'actual=$(find skills/ -type f -name "*.md" 2>/dev/null | wc -l); claimed=$(grep -oE "skills/[^)]*\([0-9]+ files\)" NEURONS.md 2>/dev/null | grep -oE "[0-9]+" | head -1 || echo 0); if [[ $claimed -lt 20 && $actual -gt 20 ]]; then echo "outdated"; else echo "ok"; fi'
expect_stdout=ok

# -----------------------------------------------------------------------------
# Waiver System Meta-Gates
# Ensures waiver system integrity
# -----------------------------------------------------------------------------

[Waiver.CountLimit]
mode=auto
gate=warn
desc=No more than 10 active waivers (keep exceptions exceptional)
cmd=bash -c 'source ../.verify/check_waiver.sh 2>/dev/null && count=$(count_active_waivers); if [[ $count -le 10 ]]; then echo "ok ($count active)"; else echo "FAIL: $count active waivers (max 10)"; fi'
expect_stdout_regex=^ok

[Waiver.NoBlanketScope]
mode=auto
gate=block
desc=No waivers with wildcard or repo-wide scope
cmd=bash -c 'found=0; shopt -s nullglob; for f in ../.verify/waivers/*.approved; do [[ -f "$f" ]] || continue; if grep -qE "PATHS=(\.|(\*)+|.*\*.*)" "$f"; then found=1; echo "FAIL: $(basename "$f") has wildcard scope"; fi; done; [[ $found -eq 0 ]] && echo "ok"'
expect_stdout=ok

[Waiver.ExpiryRequired]
mode=auto
gate=block
desc=All approved waivers have valid EXPIRES field
cmd=bash -c 'shopt -s nullglob; for f in ../.verify/waivers/*.approved; do [[ -f "$f" ]] || continue; exp=$(grep "^EXPIRES=" "$f" | cut -d= -f2); if [[ -z "$exp" ]]; then echo "FAIL: $(basename "$f") missing EXPIRES"; exit 1; fi; done; echo "ok"'
expect_stdout=ok

[Waiver.HashIntegrity]
mode=auto
gate=block
desc=Approved waivers match their request hashes (no tampering)
cmd=bash -c 'shopt -s nullglob; for f in ../.verify/waivers/*.approved; do [[ -f "$f" ]] || continue; wid=$(grep "^WAIVER_ID=" "$f" | cut -d= -f2); req="../.verify/waiver_requests/${wid}.json"; stored=$(grep "^REQUEST_SHA256=" "$f" | cut -d= -f2); if [[ -f "$req" ]]; then actual=$(sha256sum "$req" | cut -d" " -f1); if [[ "$stored" != "$actual" ]]; then echo "FAIL: ${wid} hash mismatch (request modified after approval)"; exit 1; fi; fi; done; echo "ok"'
expect_stdout=ok

[Waiver.NoUnapprovedInUse]
mode=auto
gate=warn
desc=No waiver requests referenced without corresponding approval
cmd=bash -c 'shopt -s nullglob; for req in ../.verify/waiver_requests/*.json; do [[ -f "$req" ]] || continue; wid=$(basename "$req" .json); if [[ ! -f "../.verify/waivers/${wid}.approved" ]]; then echo "PENDING: $wid (not yet approved)"; fi; done; echo "ok"'
expect_stdout_regex=ok

# =============================================================================
# Cortex File Size Limits (Lean Prompt Culture)
# =============================================================================

[Cortex.FileSizeLimit.THOUGHTS]
mode=auto
gate=warn
desc=cortex/THOUGHTS.md max 100 lines (archive old content)
cmd=bash -c 'lines=$(wc -l < ../../cortex/THOUGHTS.md 2>/dev/null || echo 0); [[ $lines -le 100 ]] && echo "ok ($lines lines)" || echo "OVER: $lines lines (max 100)"'
expect_stdout_regex=^ok

[Cortex.FileSizeLimit.SYSTEM_PROMPT]
mode=auto
gate=warn
desc=cortex/CORTEX_SYSTEM_PROMPT.md max 150 lines
cmd=bash -c 'lines=$(wc -l < ../../cortex/CORTEX_SYSTEM_PROMPT.md 2>/dev/null || echo 0); [[ $lines -le 150 ]] && echo "ok ($lines lines)" || echo "OVER: $lines lines (max 150)"'
expect_stdout_regex=^ok

[Cortex.FileSizeLimit.AGENTS]
mode=auto
gate=warn
desc=cortex/AGENTS.md max 150 lines
cmd=bash -c 'lines=$(wc -l < ../../cortex/AGENTS.md 2>/dev/null || echo 0); [[ $lines -le 150 ]] && echo "ok ($lines lines)" || echo "OVER: $lines lines (max 150)"'
expect_stdout_regex=^ok
