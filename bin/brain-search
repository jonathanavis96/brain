#!/usr/bin/env bash
# brain-search - Quick lookups across THUNK, git, cache
# Usage: brain-search [OPTIONS] <query>

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default options
SEARCH_THUNK=true
SEARCH_GIT=true
SEARCH_CACHE=false
LIMIT=10
VERBOSE=false

usage() {
  cat <<EOF
Usage: brain-search [OPTIONS] <query>

Quick lookups across THUNK, git history, and cache database.

OPTIONS:
    -t, --thunk-only     Search THUNK.md only
    -g, --git-only       Search git history only
    -c, --cache-only     Search cache database only
    -a, --all            Search all sources including cache
    -l, --limit N        Limit results per source (default: 10)
    -v, --verbose        Show verbose output
    -h, --help           Show this help message

EXAMPLES:
    brain-search "shellcheck"           # Search THUNK and git
    brain-search --all "markdown"       # Search all sources
    brain-search --thunk-only "SC2034"  # Search THUNK only
    brain-search --limit 5 "verifier"   # Limit to 5 results per source

EOF
  exit 0
}

# Parse arguments
QUERY=""
while [[ $# -gt 0 ]]; do
  case $1 in
    -t | --thunk-only)
      SEARCH_GIT=false
      SEARCH_CACHE=false
      shift
      ;;
    -g | --git-only)
      SEARCH_THUNK=false
      SEARCH_CACHE=false
      shift
      ;;
    -c | --cache-only)
      SEARCH_THUNK=false
      SEARCH_GIT=false
      SEARCH_CACHE=true
      shift
      ;;
    -a | --all)
      SEARCH_CACHE=true
      shift
      ;;
    -l | --limit)
      LIMIT="$2"
      shift 2
      ;;
    -v | --verbose)
      VERBOSE=true
      shift
      ;;
    -h | --help)
      usage
      ;;
    *)
      if [[ -z "$QUERY" ]]; then
        QUERY="$1"
      else
        echo -e "${RED}Error: Multiple queries not supported${NC}" >&2
        exit 1
      fi
      shift
      ;;
  esac
done

if [[ -z "$QUERY" ]]; then
  echo -e "${RED}Error: Query required${NC}" >&2
  usage
fi

# Detect brain root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BRAIN_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

if [[ "$VERBOSE" == "true" ]]; then
  echo -e "${CYAN}Brain root: $BRAIN_ROOT${NC}"
  echo -e "${CYAN}Query: $QUERY${NC}"
  echo -e "${CYAN}Limit: $LIMIT${NC}"
  echo
fi

# Validate LIMIT early (used by head/git/sql)
if [[ ! "$LIMIT" =~ ^[0-9]+$ ]] || [[ "$LIMIT" -lt 1 ]]; then
  echo -e "${RED}Error: --limit must be a positive integer (got: $LIMIT)${NC}" >&2
  exit 1
fi

# Pre-escape query for safe interpolation into SQLite string literals
# SQLite escapes single quotes by doubling them: ' -> ''
QUERY_SQL_ESCAPED=${QUERY//\'/\'\'}

# Track if we found anything
FOUND_RESULTS=false

# Search THUNK.md
search_thunk() {
  local thunk_file="$BRAIN_ROOT/workers/ralph/THUNK.md"

  if [[ ! -f "$thunk_file" ]]; then
    echo -e "${YELLOW}Warning: THUNK.md not found at $thunk_file${NC}" >&2
    return
  fi

  echo -e "${BOLD}${BLUE}=== THUNK.md Results ===${NC}"

  local count=0
  local matches
  matches=$(grep -i "$QUERY" "$thunk_file" | head -n "$LIMIT" || true)

  if [[ -n "$matches" ]]; then
    FOUND_RESULTS=true
    while IFS= read -r line; do
      count=$((count + 1))
      # Highlight the query term
      echo -e "${GREEN}[$count]${NC} $line"
    done <<<"$matches"

    local total
    total=$(grep -ci "$QUERY" "$thunk_file" || echo "0")
    if [[ $total -gt $LIMIT ]]; then
      echo -e "${YELLOW}... and $((total - LIMIT)) more matches${NC}"
    fi
  else
    echo -e "${YELLOW}No matches found${NC}"
  fi
  echo
}

# Search git history
search_git() {
  echo -e "${BOLD}${BLUE}=== Git Commit History ===${NC}"

  cd "$BRAIN_ROOT" || exit 1

  local count=0
  local matches
  matches=$(git log --all --oneline --grep="$QUERY" -i -n "$LIMIT" || true)

  if [[ -n "$matches" ]]; then
    FOUND_RESULTS=true
    while IFS= read -r line; do
      count=$((count + 1))
      local sha
      sha=$(echo "$line" | awk '{print $1}')
      local msg
      msg=$(echo "$line" | cut -d' ' -f2-)
      echo -e "${GREEN}[$count]${NC} ${MAGENTA}$sha${NC} $msg"
    done <<<"$matches"

    local total
    total=$(git log --all --oneline --grep="$QUERY" -i | wc -l || echo "0")
    if [[ $total -gt $LIMIT ]]; then
      echo -e "${YELLOW}... and $((total - LIMIT)) more commits${NC}"
    fi
  else
    echo -e "${YELLOW}No commits found${NC}"
  fi
  echo
}

# Search cache database
search_cache() {
  local cache_db="$BRAIN_ROOT/workers/ralph/artifacts/rollflow_cache/cache.sqlite"

  if [[ ! -f "$cache_db" ]]; then
    echo -e "${YELLOW}Warning: Cache database not found at $cache_db${NC}" >&2
    return
  fi

  echo -e "${BOLD}${BLUE}=== Cache Database ===${NC}"

  # Search in tool_name and arguments
  local query_sql="SELECT tool_name, timestamp, status, duration_ms
                     FROM tool_calls
                     WHERE tool_name LIKE '%$QUERY_SQL_ESCAPED%'
                        OR arguments LIKE '%$QUERY_SQL_ESCAPED%'
                     ORDER BY timestamp DESC
                     LIMIT $LIMIT;"

  local results
  results=$(sqlite3 "$cache_db" "$query_sql" 2>/dev/null || true)

  if [[ -n "$results" ]]; then
    FOUND_RESULTS=true
    local count=0
    while IFS='|' read -r tool_name timestamp status duration_ms; do
      count=$((count + 1))
      local status_color="$GREEN"
      if [[ "$status" == "FAIL" ]]; then
        status_color="$RED"
      elif [[ "$status" == "UNKNOWN" ]]; then
        status_color="$YELLOW"
      fi
      echo -e "${GREEN}[$count]${NC} ${CYAN}$tool_name${NC} - ${status_color}$status${NC} (${duration_ms}ms) @ $timestamp"
    done <<<"$results"
  else
    echo -e "${YELLOW}No cache entries found${NC}"
  fi
  echo
}

# Execute searches
if [[ "$SEARCH_THUNK" == "true" ]]; then
  search_thunk
fi

if [[ "$SEARCH_GIT" == "true" ]]; then
  search_git
fi

if [[ "$SEARCH_CACHE" == "true" ]]; then
  search_cache
fi

# Exit with appropriate code
if [[ "$FOUND_RESULTS" == "true" ]]; then
  exit 0
else
  echo -e "${RED}No results found for: $QUERY${NC}" >&2
  exit 1
fi
